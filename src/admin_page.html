<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="utf-8">
  <title>Main Page</title>
  <link rel="stylesheet" href="admin_page.css">
</head>
<body>
  <img src="logo.png" alt="Logo" class="logo">
  <img id="userImage" alt="User Image" src="newuser.png" class="userPicture">
  <div class="banner">
    <h1 id="dataDisplay"></h1>
    
  </div>
  
  <div class="container">
    <form class="form " id="mainPage">
    <h2>Main Content</h2>
    <p>This is the main content of your webpage contained within a container.</p>
    <p>Content Goes Here</p>
    <ul id="userList"></ul>
    <button class="form__button" id="createUser" type="submit">Create New User</button>
    
  </form>
  <form class="form form--hidden" id="createNewAccount">
    <h1 class="form__title">Create New Account</h1>
      <div class="form__message form__message--error"></div>
      <div class="form__input-group">
        <input type="text" id="firstName" class="form__input" autofocus placeholder="First Name">
        <div class="form__input--error-message"></div>
      </div>
      <div class="form__input-group">
        <input type="text" id="lastName" class="form__input" autofocus placeholder="Last Name">
        <div class="form__input--error-message"></div>
      </div>
      <div class="form__input-group">
        <input type="text" id="address" class="form__input" autofocus placeholder="Address">
        <div class="form__input--error-message"></div>
      </div>
      <div class="form__input-group">
        <input type="date" id="dateOfBirth" class="form__input" autofocus placeholder="Date of Birth: 2002-17-02">
        <div class="form__input--error-message"></div>
      </div>
      <div class="form__input-group">
        <input type="text" id="realEmail" class="form__input" autofocus placeholder="Email Address">
        <div class="form__input--error-message"></div>
      </div>
      <div class="form__input-group">
        <input type="password"  id="realPassword" id="password" class="form__input" autofocus placeholder="Password">
        <div class="form__input--error-message"></div>
      </div>
      <div class="form__input-group">
        <input type="text" id="authentication" class="form__input" autofocus placeholder="Authentication">
        <div class="form__input--error-message"></div>
      </div>
      <button class="form__button" id="submitData">Create Account</button>
      <p class="form__text">
        <a href="#" class="form__link"></a>
      </p>
      <p class="form__text">
        <a class="form__link" id="linkReturn">Cancel</a>
      </p>
  </form>
  <form class="form form--hidden" id="updateAccount">
    <h1 class="form__title">Update Account Information</h1>
      <div class="form__message form__message--error"></div>
      <div class="form__input-group">
        <input type="text" id="updatefirstName" class="form__input" autofocus placeholder="First Name">
        <div class="form__input--error-message"></div>
      </div>
      <div class="form__input-group">
        <input type="text" id="updatelastName" class="form__input" autofocus placeholder="Last Name">
        <div class="form__input--error-message"></div>
      </div>
      <div class="form__input-group">
        <input type="text" id="updateaddress" class="form__input" autofocus placeholder="Address">
        <div class="form__input--error-message"></div>
      </div>
      <div class="form__input-group">
        <input type="date" id="updatedateOfBirth" class="form__input" autofocus placeholder="Date of Birth: 2002-17-02">
        <div class="form__input--error-message"></div>
      </div>
      <div class="form__input-group">
        <input type="text" id="updaterealEmail" class="form__input" autofocus placeholder="Email Address">
        <div class="form__input--error-message"></div>
      </div>
      <div class="form__input-group">
        <input type="password"  id="updaterealPassword" id="password" class="form__input" autofocus placeholder="Password">
        <div class="form__input--error-message"></div>
      </div>
      <div class="form__input-group">
        <input type="text" id="updateauthentication" class="form__input" autofocus placeholder="Authentication">
        <div class="form__input--error-message"></div>
      </div>
      <button class="form__button" id="updateData">Update Account</button>
      <button class="form__button" id="activateUser"></button>
      <button class="form__button" id="emailUser">Send Email to User</button>
      <p class="form__text">
        <a href="#" class="form__link"></a>
      </p>
      <p class="form__text">
        <a class="form__link" id="linkReturnUpdate">Cancel</a>
      </p>
  </form>
  <form class="form form--hidden" id="email">
    <div class="field">
      <label for="frname">subject</label>
      <input type="text" name="subject" id="subject">
    </div>
    <div class="field">
      <label for="message">message</label>
      <input type="text" name="message" id="message">
    </div>
    
  
    <button class="form__button" id="sendEmailButton">Send Email</button>
  </form>
  </div>
  <script type="text/javascript" src="https://cdn.emailjs.com/dist/email.min.js"></script>
  <script type="text/javascript">
    (function () {
      emailjs.init("Do1B22pVrG5JOMZyR"); // Replace with your EmailJS user ID
    })();
  </script>
  <script type="module">

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
  import { getDatabase, set, ref, update, get } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
  const firebaseConfig = {
          apiKey: "AIzaSyCjKjeEiIpaLybLGQzoPlnGp1D6XYuh8Lw",
          authDomain: "swe4713temp.firebaseapp.com",
          databaseURL: "https://swe4713temp-default-rtdb.firebaseio.com",
          projectId: "swe4713temp",
          storageBucket: "swe4713temp.appspot.com",
          messagingSenderId: "1067050664646",
          appId: "1:1067050664646:web:c07f85156618fcbb59cdc7",
          measurementId: "G-7L55RX7DM3"
        };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase();

    const auth = getAuth(app);
    
    //when selected user gets stored to update for later
    let selectedUserId = null;

    document.addEventListener("DOMContentLoaded", () => {
        const mainForm = document.querySelector("#mainPage");
        const createNewAccountForm = document.querySelector("#createNewAccount");
        const updateAccountForm = document.querySelector("#updateAccount")
        const emailForm = document.querySelector("#email")

    
        //on click hides hides create new account and unhides mainpage
        document.querySelector("#linkReturn").addEventListener("click", e => {
            e.preventDefault();
            createNewAccountForm.classList.add("form--hidden");
            mainForm.classList.remove("form--hidden");
            updateAccountForm.add("form--hidden");
        });

        document.querySelector("#createUser").addEventListener("click", e => {
            e.preventDefault();
            createNewAccountForm.classList.remove("form--hidden");
            mainForm.classList.add("form--hidden");
        });

        document.getElementById("linkReturnUpdate").addEventListener("click", e => {
            e.preventDefault();
            updateAccountForm.classList.add("form--hidden");
            mainForm.classList.remove("form--hidden");
        });

        document.getElementById("emailUser").addEventListener("click", e => {
          e.preventDefault();
          updateAccountForm.classList.add("form--hidden");
          emailForm.classList.remove("form--hidden");
        })

        document.getElementById("submitData").addEventListener('click', e => {
            e.preventDefault();
        });

        document.getElementById('updateData').addEventListener('click', (e) => {
          e.preventDefault();
        });

        
    });


    document.querySelectorAll(".form__input").forEach(inputElement => {
            inputElement.addEventListener("blur", e => {
                if (e.target.id === "realPassword" && e.target.value.length > 0 && e.target.value.length < 8) {
                    setInputError(inputElement, "Password must be at least 8 characters in length");
                } else if (e.target.id === "realPassword" && hasValue(e.target.value) === false) {
                    setInputError(inputElement, "Password must contain at least one number, one letter, and one special character");
                }
            });
            
            inputElement.addEventListener("input", e => {
                clearInputError(inputElement);
            });
        });


        function updateFormWithData(user) {
          // Update the form fields with the user's data
          
          document.getElementById('updatefirstName').value = user.firstName;
          document.getElementById('updatelastName').value = user.lastName;
          document.getElementById('updateaddress').value = user.address;
          document.getElementById('updatedateOfBirth').value = user.dateOfBirth;
          document.getElementById('updaterealEmail').value = user.email;
          document.getElementById('updaterealPassword').value = user.password;

          if(user.cred === 0){
            document.getElementById('updateauthentication').value = 'user';
          }else if(user.cred === 1){
            document.getElementById('updateauthentication').value = 'manager';
          } else if(user.cred === 2){
            document.getElementById('updateauthentication').value = 'admin';
          }else {
            document.getElementById('updateauthentication').value = user.cred;
          }
        }


        function rearrangeDate(originalDate) {
            // Split the original date into an array of parts: [YYYY, MM, DD]
            const dateParts = originalDate.split('-');
      
            // Extract the month and year
            const year = dateParts[0].substring(2);  // Take the last two digits of the year
            const month = dateParts[1];
      
            // Concatenate and return the rearranged date (MMYY format)
            const rearrangedDate = `${month}${year}`;
            return rearrangedDate;
      }


    //copy code from index for creating user
    function makeUsername(firstName, lastName, dateOfBirth){
            const firstChar = firstName[0];
            const newUserName = firstChar + lastName + dateOfBirth;
            return newUserName;
        }
    
        function hasNumber(input) {
            return /\d/.test(input);
        }
    
        function hasSpecialChar(input) {
            const specialChars = /[!@#$%^&*(),.?":{}|<>]/;
    
            return specialChars.test(input);
        }
    
        function hasLetter(input) {
            const letter = /[a-zA-Z]/;
    
            return letter.test(input);
        }
    
        function hasValue(input) {
            return hasNumber(input) && hasLetter(input) && hasSpecialChar(input);
        }
    
        function setInputError(inputElement, message){
            inputElement.classList.add("form__input--error");
            inputElement.parentElement.querySelector(".form__input--error-message").textContent = message;
        } 
    
        function clearInputError(inputElement) {
            inputElement.classList.remove("form__input--error");
            inputElement.parentElement.querySelector(".form__input--error-message").textContent = "";
        }

        //takes in element form, the tpye of form (in this case we only have Sucess and Error for all of index), and the message which should be sent. (in case of username and password. Type stays error but message changes to indicate the error)
        function setFormMessage(formElement, type, message) {
            const messageElement = formElement.querySelector(".form__message");
    
            messageElement.textContent = message;
            messageElement.classList.remove("form__message--success", "form__message--error");
            messageElement.classList.add(`form__message--${type}`);
        }



    async function getUserData(uid) {
      const userRef = ref(database, 'users/' + uid);
      const snapshot = await get(userRef);
      if (snapshot.exists()) {
        const userData = snapshot.val();
        return userData.username;
      } else {
        return null;
      }
    }

    async function displayUserData() {
      const mainForm = document.querySelector("#mainPage");
      const createNewAccountForm = document.querySelector("#createNewAccount");
      const updateAccountForm = document.querySelector("#updateAccount");
      const uids = getDataFromQuery();
      const userList = document.getElementById('userList');

      if (uids) {
        const username = await getUserData(uids);
        document.getElementById('dataDisplay').innerText = 'User: ' + (username || 'User not found');
        document.getElementById('userImage').style.display = username ? 'block' : 'none';
      } else {
        document.getElementById('dataDisplay').innerText = 'No user UID passed.';
        document.getElementById('userImage').style.display = 'none';
      }

      const usersRef = ref(database, 'users');
      const usersSnapshot = await get(usersRef);

      if (usersSnapshot.exists()) {
        const users = usersSnapshot.val();
        const sortedUsers = Object.values(users).sort((a, b) => a.cred - b.cred);

        userList.innerHTML = '';  // Clear previous user list

        sortedUsers.forEach(user => {
          const userItem = document.createElement('li');
          const userLink = document.createElement('a');
    
          // Set the link URL with the user's UID and add an event listener
          userLink.href = `javascript:void(0);`;
          userLink.addEventListener('click', () => {
            selectedUserId = user.id;
            
            if(user.active){
              document.getElementById('activateUser').textContent = 'Deactivate Account';
            }else{
              document.getElementById('activateUser').textContent = 'Activate Account';
            }
            
            updateAccountForm.classList.remove('form--hidden');
            createNewAccountForm.classList.add('form--hidden');
            mainForm.classList.add('form--hidden');
            
           
            
            
            // Set the data in the update account form based on the clicked user
            updateFormWithData(user);
          });

          userLink.textContent = `Username: ${user.username}, Cred: ${user.cred}`;
          userItem.appendChild(userLink);
          
          userList.appendChild(userItem);
        });
      }
    }

    function getDataFromQuery() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('data');
    }

    function activateEmail(){
      if (!selectedUserId) {
        alert('No user selected.');
        return;
      }

      // Fetch the user's email address based on the selectedUserId
      const userRef = ref(database, 'users/' + selectedUserId);
      get(userRef)
      .then((snapshot) => {
       if (snapshot.exists()) {
         const userData = snapshot.val();
         const userEmail = userData.email;
         const active = userData.active;
         let message = null;

         if(active){
          message = 'Your Account has been activated';
         }else {
          message = 'Your Account has been deactivated';
         }

         

         // Prepare the email parameters
         const emailParams = {
            to_email: userEmail,  // Replace with the recipient's email address
            subject: 'Account Activation Status',  // Replace with the desired subject
            message: message  // Replace with the desired email content
         };

         // Send the email using EmailJS
         emailjs.send('service_uhjncdn', 'template_57xcxk7', emailParams)
           .then((response) => {
             alert('Email sent successfully!', response);
            })
            .catch((error) => {
              alert('Error sending email:', error);
            });
        } else {
         alert('User not found.');
        }
      })
      .catch((error) => {
       alert('Error fetching user data: ' + error.message);
     });
    }


    submitData.addEventListener('click', (e) => {
            
    
            var email = document.getElementById('realEmail').value;
            var password = document.getElementById('realPassword').value;
            var authentication = document.getElementById('authentication').value;
            var firstName = document.getElementById('firstName').value;
            var lastName = document.getElementById('lastName').value;
            var date = document.getElementById('dateOfBirth').value;
            var address = document.getElementById('address').value;
            var reDate = rearrangeDate(date);
            var userName = makeUsername(firstName, lastName, reDate);

    
            if (!email || !password || !firstName || !lastName || !date || !address || !authentication) {
                
                if(!email){
                    setInputError(document.getElementById('realEmail'), 'please enter your Email');
                }
                if(!password) {
                    setInputError(document.getElementById('realPassword'), 'please enter your password');
                }
                if(!firstName){
                    setInputError(document.getElementById('firstName'), 'please enter your First Name');
                }
                if(!lastName){
                    setInputError(document.getElementById('lastName'), 'please enter your Last Name');
                }
                if(!date){
                    setInputError(document.getElementById('dateOfBirth'), 'please enter your Birth Date');
                }
                if(!address){
                    setInputError(document.getElementById('address'), 'please enter your address');
                }
                if(!authentication){
                  setInputError(document.getElementById('authentication'), 'please enter the creds');
                }
                return; // Stop further execution
            } 
            var cred;
            if(authentication === 'user'){
              cred = 0;
            }else if(authentication === 'manager'){
              cred = 1;
            }else if(authentication === 'admin'){
              cred = 2;
            }else{
              setInputError(document.getElementById('authentication'), 'That is not a correct cred');
              return; //stop further execution
            }
                
    
    
            createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                 // Signed in 
                const user = userCredential.user;
                // ...
                set(ref(database, 'users/' + user.uid), {
                    username: userName,
                    email: email,
                    password: password,
                    firstName: firstName,
                    lastName: lastName,
                    dateOfBirth: date,
                    address: address,
                    cred: cred,
                    id: user.uid,
                    active: true
                })
                    .then(() => {
                      // Data saved successfully!
                      alert('user created successfully')
                    })
                    .catch((error) => {
                    // The write failed...
                      alert(error);
                    });
                
            })
            .catch((error) => {
                const errorCode = error.code;
                const errorMessage = error.message;
                // ..
                alert(error.message)
            }); 
    
            
        }); 

        updateData.addEventListener('click', (e) => {
          e.preventDefault();

          if(!selectedUserId) {
            alert(selectedUserId);
            return;
          }

          const updatedFirstName = document.getElementById('updatefirstName').value;
          const updatedLastName = document.getElementById('updatelastName').value;
          const updatedAddress = document.getElementById('updateaddress').value;
          const updatedDateOfBirth = document.getElementById('updatedateOfBirth').value;
          const updatedEmail = document.getElementById('updaterealEmail').value;
          const updatedPassword = document.getElementById('updaterealPassword').value;
          const updatedAuthentication = document.getElementById('updateauthentication').value;

          // Rearrange the updated date of birth
          const updatedReDate = rearrangeDate(updatedDateOfBirth);

          // Generate the updated username
          const updatedUserName = makeUsername(updatedFirstName, updatedLastName, updatedReDate);

          if (!updatedEmail || !updatedPassword || !updatedFirstName || !updatedLastName || !updatedDateOfBirth || !updatedAddress || !updatedAuthentication) {
                
                if(!updatedEmail){
                    setInputError(document.getElementById('updaterealEmail'), 'please enter your Email');
                }
                if(!updatedPassword) {
                    setInputError(document.getElementById('updaterealPassword'), 'please enter your password');
                }
                if(!updatedFirstName){
                    
                    setInputError(document.getElementById('updatefirstName'), 'please enter your First Name');
                }
                if(!updatedLastName){
                    setInputError(document.getElementById('updatelastName'), 'please enter your Last Name');
                }
                if(!updatedDateOfBirth){
                    setInputError(document.getElementById('updatedateOfBirth'), 'please enter your Birth Date');
                }
                if(!updatedAddress){
                    setInputError(document.getElementById('updateaddress'), 'please enter your address');
                }
                if(!updatedAuthentication){
                  setInputError(document.getElementById('updateauthentication'), 'please enter the creds');
                }
                return; // Stop further execution
            } 
            var cred;
            if(updatedAuthentication === 'user'){
              cred = 0;
            }else if(updatedAuthentication === 'manager'){
              cred = 1;
            }else if(updatedAuthentication === 'admin'){
              cred = 2;
            }else{
              setInputError(document.getElementById('authentication'), 'That is not a correct cred');
              return; //stop further execution
            }


          // Update the user data in the database
          const userRef = ref(database, 'users/' + selectedUserId);
          const updates = {
            username: updatedUserName,
            email: updatedEmail,
            password: updatedPassword,
            firstName: updatedFirstName,
            lastName: updatedLastName,
            dateOfBirth: updatedDateOfBirth,
            address: updatedAddress,
            cred: cred
          };
  update(userRef, updates)
          .then(() => {
          // Data updated successfully
          alert('User data updated successfully');
          })
          .catch((error) => {
          // Update failed
          alert('Failed to update user data: ' + error.message);
          });
        });



      document.getElementById('activateUser').addEventListener('click', (e) => {
        e.preventDefault();

        if (!selectedUserId) {
          alert('No user selected.');
          return;
        }

        const userRef = ref(database, 'users/' + selectedUserId);
        
        // Get the current user's data
        get(userRef)
        .then((snapshot) => {
          if (snapshot.exists()) {
            const userData = snapshot.val();
            const updatedActiveState = !userData.active; // Toggle the active state

            // Update the 'active' field in the database
            update(userRef, { active: updatedActiveState })
              .then(() => {
                if(updatedActiveState){
                  alert(`User Activated`);
                  activateEmail();
                  document.getElementById('activateUser').textContent = 'Deactivate Account';
                }else{
                  alert('User Deactivated');
                  activateEmail();
                  document.getElementById('activateUser').textContent = 'Activate Account';
                }
                
              })
              .catch((error) => {
                alert('Failed to update user activation status: ' + error.message);
             });
          } else {
          alert('User not found.');
          }
        })
        .catch((error) => {
          alert('Error fetching user data: ' + error.message);
        });
      });

      document.getElementById('sendEmailButton').addEventListener('click', (e) => {
  e.preventDefault();

  if (!selectedUserId) {
    alert('No user selected.');
    return;
  }

  // Fetch the user's email address based on the selectedUserId
  const userRef = ref(database, 'users/' + selectedUserId);
  get(userRef)
    .then((snapshot) => {
      if (snapshot.exists()) {
        const userData = snapshot.val();
        const userEmail = userData.email;
        const emailSubject = document.getElementById('subject').value;
        const emailMessage = document.getElementById('message').value;
        alert(emailSubject);
        alert(emailMessage);

        // Prepare the email parameters
        const emailParams = {
          to_email: userEmail,  // Replace with the recipient's email address
          subject: emailSubject,  // Replace with the desired subject
          message: emailMessage   // Replace with the desired email content
        };

        // Send the email using EmailJS
        emailjs.send('service_uhjncdn', 'template_57xcxk7', emailParams)
          .then((response) => {
            alert('Email sent successfully!', response);
          })
          .catch((error) => {
            alert('Error sending email:', error);
          });
      } else {
        alert('User not found.');
      }
    })
    .catch((error) => {
      alert('Error fetching user data: ' + error.message);
    });
});

    displayUserData(); // Call the function after defining it

  </script>
</body>
</html>